name: RDP-Main

on:
  workflow_dispatch:
  repository_dispatch:
    types: [restart-runner]

jobs:
  rdp:
    runs-on: windows-latest
    timeout-minutes: 360
    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with: { dotnet-version: '8.0.x' }

      - name: Build Fake App
        run: |
          New-Item -ItemType Directory -Path FakeBuild -Force
          Set-Location FakeBuild
          dotnet new console -n KeepAliveApp --force
          Set-Location KeepAliveApp
          (Get-Content Program.cs) -replace 'Hello, World!', 'GitHub Actions æ°¸ä¹… Runner - Build ${{ github.run_id }} - $(Get-Date)' | Set-Content Program.cs
          dotnet publish -c Release -o ../publish -p:UseAppHost=false
          "Build $(Get-Date)" | Out-File -FilePath ../publish/info.txt

      - name: Enable RDP
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
          netsh advfirewall firewall add rule name="RDP-Auto-$(Get-Random)" dir=in action=allow protocol=TCP localport=3389

      - name: Create Random User
        run: |
          $u = "u$(Get-Random -Min 10000 -Max 99999)"
          $p = -join ((33..126) | Get-Random -Count 28 | % {[char]$_})
          $s = ConvertTo-SecureString $p -AsPlainText -Force
          New-LocalUser $u -Password $s -FullName "AutoUser" -Description "auto"
          Add-LocalGroupMember -Group "Administrators" -Member $u
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member $u
          echo "USER=$u" >> $env:GITHUB_ENV
          echo "PASS=$p" >> $env:GITHUB_ENV

      - name: Install & Start Tailscale
        run: |
          iwr https://pkgs.tailscale.com/stable/Tailscale-latest-amd64.msi -OutFile "$env:TEMP\ts.msi"
          msiexec /i "$env:TEMP\ts.msi" /quiet /norestart
          & "C:\Program Files\Tailscale\tailscale.exe" up --authkey=${{ secrets.TS_KEY }} --hostname="auto-${{ github.run_id }}" --accept-routes=false
          for($i=0;$i -lt 25;$i++){ $ip=& "C:\Program Files\Tailscale\tailscale.exe" ip --4 2>$null; if($ip){echo "IP=$ip" >> $env:GITHUB_ENV; break}; Start-Sleep 6 }

      - name: Upload Fake Artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ github.run_id }}
          path: FakeBuild/publish/**
          retention-days: 2

      # é—œéµï¼šæ¨é€è¨Šæ¯åˆ° Telegram
      - name: Send to Telegram
        run: |
          $msg = @"
ğŸŸ¢ æ–° Windows é›²é›»è…¦å·²å°±ç·’ï¼ˆè‡ªå‹•çºŒå‘½ä¸­ï¼‰

ğŸ–¥ï¸  IP      : $($env:IP)
ğŸ‘¤  User    : $($env:USER)
ğŸ”‘  Pass    : $($env:PASS)

â° å•Ÿå‹•æ™‚é–“ : $(Get-Date -Format "yyyy-MM-dd HH:mm:ss") UTC
#${{ github.run_id }}
"@
          $msg = [System.Web.HttpUtility]::UrlEncode($msg)
          iwr "https://api.telegram.org/bot${{ secrets.TG_BOT_TOKEN }}/sendMessage?chat_id=${{ secrets.TG_CHAT_ID }}&text=$msg&parse_mode=HTML" -UseBasicParsing | Out-Null
          Write-Host "å·²æ¨é€åˆ° Telegram"

      # è‡ªå‹•çºŒå‘½ + é¡¯ç¤º
      - name: Keep-Alive & Auto-Renew
        run: |
          Write-Host "é€™å°æ©Ÿå™¨å°‡è‡ªå‹•çºŒå‘½ï¼Œæ°¸ä¸æ‰ç·š"
          $c = 0
          while($true) {
            $c++
            $delay = Get-Random -Min 14400 -Max 32400   # 4~9 å°æ™‚

            if($c -eq 1) {
              Start-Sleep -Seconds (Get-Random -Min 600 -Max 1200)
              Write-Host "æå‰å•Ÿå‹•æ¥ç­æ©Ÿå™¨..."
              iwr -Uri "https://api.github.com/repos/${{ github.repository }}/dispatches" `
                -Method POST -Headers @{ Authorization = "token ${{ secrets.AUTO_RESTART_PAT }}" } `
                -ContentType "application/json" -Body '{"event_type":"restart-runner"}'
            }
            Start-Sleep -Seconds $delay
          }
